name: 📥 Download & Commit indexPriceKlines (1h & 4h)

on:
  workflow_dispatch:

jobs:
  download:
    name: ⬇️ Download indexPriceKlines | ${{ matrix.symbol }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        symbol: [BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, XRPUSDT, ENAUSDT]
      max-parallel: 6

    steps:
      - name: 🛎️ Checkout repo
        uses: actions/checkout@v3

      - name: 🔧 Install unzip & curl
        run: sudo apt-get update && sudo apt-get install -y unzip curl

      - name: 📥 Download & extract indexPriceKlines (1h & 4h)
        shell: bash
        run: |
          set -euo pipefail
          SYMBOL=${{ matrix.symbol }}
          START="2020-01-01"
          END=$(date -I -d "yesterday")
          INTERVALS=( "1h" "4h" )

          for iv in "${INTERVALS[@]}"; do
            BASE="data/futures/um/daily/indexPriceKlines/${SYMBOL}/${iv}"
            mkdir -p "$BASE"
            echo "→ Downloading indexPriceKlines for $SYMBOL at interval $iv"
            cur="$START"
            while [[ "$cur" < "$END" || "$cur" == "$END" ]]; do
              DATE=$(date -d "$cur" +%Y-%m-%d)
              ZIP="${SYMBOL}-${iv}-${DATE}.zip"
              URL="https://data.binance.vision/data/futures/um/daily/indexPriceKlines/${SYMBOL}/${iv}/${ZIP}"
              echo "    → Fetching $ZIP"
              if curl -sSf "$URL" -o tmp.zip; then
                unzip -p tmp.zip > "$BASE/${ZIP%.zip}.csv"
                rm tmp.zip
                echo "       ✅ extracted ${ZIP}"
              else
                echo "       ⚠️ missing ${ZIP}"
                rm -f tmp.zip || true
              fi
              cur=$(date -I -d "$cur +1 day")
            done
          done

          echo "📊 Disk usage after indexPriceKlines download:"
          df -h .
          for iv in "${INTERVALS[@]}"; do
            du -sh "data/futures/um/daily/indexPriceKlines/${SYMBOL}/${iv}" || true
          done

      - name: 📦 Upload indexPriceKlines artifacts
        uses: actions/upload-artifact@v4
        with:
          name: data-indexPriceKlines-${{ matrix.symbol }}
          path: |
            data/futures/um/daily/indexPriceKlines/${{ matrix.symbol }}/1h/*
            data/futures/um/daily/indexPriceKlines/${{ matrix.symbol }}/4h/*

  aggregate_and_push:
    name: 🚀 Aggregate & Commit indexPriceKlines Data
    needs: download
    runs-on: ubuntu-latest

    steps:
      - name: 🛎️ Checkout fresh
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: 📥 Download indexPriceKlines artifacts
        uses: actions/download-artifact@v4
        with:
          path: data-artifacts

      - name: 🔀 Merge indexPriceKlines into historical_tech
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p historical_tech/indexPriceKlines
          find data-artifacts -type f | while read src; do
            rel=${src#data-artifacts/data/futures/um/daily/indexPriceKlines/}
            dst="historical_tech/indexPriceKlines/${rel}"
            mkdir -p "$(dirname "$dst")"
            mv "$src" "$dst"
          done

      - name: 🚀 Commit & Push indexPriceKlines
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --mixed origin/main
          git add historical_tech/indexPriceKlines
          if git diff --cached --quiet; then
            echo "✅ No new indexPriceKlines to commit"
          else
            git commit -m "chore(data): import indexPriceKlines 1h & 4h [skip ci]"
            git push origin HEAD:main
          fi
