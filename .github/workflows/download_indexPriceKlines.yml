name: 2Ô∏è‚É£üìÇ Download & Commit indexPriceKlines (1h & 4h)

on:
  workflow_dispatch:
  schedule:
    - cron: '10 8 * * *'  # t√§glich 08:10 UTC

jobs:
  download:
    name: ‚¨áÔ∏è Download indexPriceKlines | ${{ matrix.symbol }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        symbol: [BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, XRPUSDT, ENAUSDT]
      max-parallel: 6

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y unzip curl

      - name: Determine yesterday
        id: dates
        run: |
          YESTERDAY=$(date -I -d 'yesterday')
          echo "end=$YESTERDAY" >> $GITHUB_OUTPUT

      - name: Download & extract yesterday‚Äôs indexPriceKlines
        shell: bash
        run: |
          set -euo pipefail
          SYMBOL=${{ matrix.symbol }}
          DATE=${{ steps.dates.outputs.end }}
          BASE="raw/indexKlines/${SYMBOL}"
          mkdir -p "$BASE"

          for iv in 1h 4h; do
            ZIP="${SYMBOL}-${iv}-${DATE}.zip"
            URL="https://data.binance.vision/data/futures/um/daily/indexPriceKlines/${SYMBOL}/${iv}/${ZIP}"
            echo "‚Üí Fetching $URL"
            if curl -sSf "$URL" -o tmp.zip; then
              unzip -p tmp.zip > "${BASE}/${ZIP%.zip}.csv"
              rm tmp.zip
            else
              echo "‚ö†Ô∏è Missing $ZIP ‚Äì skipping"
              rm -f tmp.zip
            fi
          done

      - name: Upload yesterday‚Äôs indexPriceKlines only
        uses: actions/upload-artifact@v4
        with:
          name: indexPriceKlines-${{ matrix.symbol }}
          path: raw/indexKlines/${{ matrix.symbol }}/*-${{ steps.dates.outputs.end }}.csv
          if-no-files-found: ignore

  aggregate_and_push:
    name: üöö Merge & Commit indexPriceKlines
    needs: download
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fresh
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Cleanup legacy folders
        run: rm -rf raw/indexKlines/historical-*

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Merge CSVs into raw/indexKlines
        shell: bash
        run: |
          set -euo pipefail
          # f√ºr jede CSV im Artifact
          find artifacts -type f -name '*.csv' | while read SRC; do
            SYMBOL=$(basename "$(dirname "$SRC")")  # artifacts/<symbol>/<file>.csv
            DST="raw/indexKlines/${SYMBOL}/$(basename "$SRC")"
            mkdir -p "$(dirname "$DST")"
            mv "$SRC" "$DST"
            echo " ‚ûï $DST"
          done

      - name: Commit & Push
        shell: bash
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add raw/indexKlines
          if git diff --cached --quiet; then
            echo "‚úÖ No new indexPriceKlines to commit"
          else
            git commit -m "chore(history): import indexPriceKlines ${{ steps.dates.outputs.end }} [skip ci]"
            git push origin HEAD:main
          fi
