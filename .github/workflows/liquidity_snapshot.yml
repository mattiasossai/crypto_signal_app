# .github/workflows/liquidity_snapshot.yml
# â€¦ (der Teil bis capture_snapshots bleibt unverÃ¤ndert) â€¦

  aggregate_and_push:
    name: ðŸ“Š Aggregate & Commit All Snapshots
    runs-on: ubuntu-latest
    needs: capture_snapshots

    steps:
      - name: ðŸ›Žï¸ Checkout fresh
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: ðŸ“¥ Download all snapshot-artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./snapshots-artifacts

      - name: ðŸ”€ Merge snapshots into repo
        shell: bash
        run: |
          # Verzeichnisse sicher anlegen (verhindert 'No such file or directory')
          mkdir -p snapshots snapshots-artifacts

          # Aktivieren von **-Globbing, um rekursiv zu suchen
          shopt -s globstar

          MOVED=0
          for src in snapshots-artifacts/**/*.json; do
            if [[ -f "$src" ]]; then
              rel=${src#snapshots-artifacts/}
              dst="snapshots/$rel"
              mkdir -p "$(dirname "$dst")"
              mv "$src" "$dst"
              ((MOVED++))
            fi
          done

          echo "Moved $MOVED snapshot files"
          echo "MOVED=$MOVED" >> $GITHUB_ENV

      - name: ðŸš€ Commit & Push all Snapshots
        if: env.MOVED != '0'
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --mixed origin/main
          git add snapshots
          git commit -m "chore(snapshots): add daily liquidity [skip ci]"
          git push origin HEAD:main

      - name: âœ… No new snapshots to commit
        if: env.MOVED == '0'
        run: echo "ðŸš€ No new snapshots to commit"
