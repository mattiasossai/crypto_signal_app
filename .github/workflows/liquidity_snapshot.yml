name: 💧 Full Liquidity Snapshot & Push

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  capture_snapshots:
    name: 🔄 Capture Liquidity Snapshots for ${{ matrix.symbol }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        symbol: [BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, XRPUSDT, ENAUSDT]
      max-parallel: 6

    env:
      PROXY_URL: ${{ secrets.RAILWAY_PROXY_URL }}

    steps:
      - name: 🛎️ Checkout repo
        uses: actions/checkout@v3

      - name: 🔧 Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: 💽 Capture Futures Depth via Proxy
        run: |
          DATE=$(date -I)
          mkdir -p snapshots/futures/${{ matrix.symbol }}
          curl -sSf -G "${PROXY_URL}/proxy" \
            --data-urlencode "url=https://fapi.binance.com/fapi/v1/depth?symbol=${{ matrix.symbol }}&limit=500" \
            | jq . > snapshots/futures/${{ matrix.symbol }}/$DATE.json

      - name: 💾 Capture Spot Depth via Proxy
        run: |
          DATE=$(date -I)
          mkdir -p snapshots/spot/${{ matrix.symbol }}
          curl -sSf -G "${PROXY_URL}/proxy" \
            --data-urlencode "url=https://api.binance.com/api/v3/depth?symbol=${{ matrix.symbol }}&limit=500" \
            | jq . > snapshots/spot/${{ matrix.symbol }}/$DATE.json

      - name: 📦 Upload snapshot-artifact
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-${{ matrix.symbol }}
          if-no-files-found: warn
          path: |
            snapshots/futures/${{ matrix.symbol }}/*.json
            snapshots/spot/${{ matrix.symbol }}/*.json

  aggregate_and_push:
    name: 📊 Aggregate & Commit All Snapshots
    runs-on: ubuntu-latest
    needs: capture_snapshots

    steps:
      - name: 🛎️ Checkout fresh
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: 📥 Download all snapshot-artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./snapshots-artifacts
          if-no-files-found: ignore

      - name: 🔀 Merge snapshots into repo
        shell: bash
        run: |
          mkdir -p snapshots snapshots-artifacts
          shopt -s globstar
          MOVED=0
          for src in snapshots-artifacts/**/*.json; do
            if [[ -f "$src" ]]; then
              rel=${src#snapshots-artifacts/}
              dst="snapshots/$rel"
              mkdir -p "$(dirname "$dst")"
              mv "$src" "$dst"
              ((MOVED++))
            fi
          done
          echo "MOVED=$MOVED" >> $GITHUB_ENV

      - name: 🚀 Commit & Push all Snapshots
        if: env.MOVED != '0'
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --mixed origin/main
          git add snapshots
          git commit -m "chore(snapshots): add daily liquidity [skip ci]"
          git push origin HEAD:main

      - name: ✅ No new snapshots to commit
        if: env.MOVED == '0'
        run: echo "🚀 No new snapshots to commit"
