# .github/workflows/bookdepth-incremental.yml
name: "ðŸ“¥ Incremental Download & Feature bookDepth per Symbol"

on:
  workflow_dispatch:
    inputs:
      start_date: { description: 'Startdatum (YYYY-MM-DD)', required: true }
      end_date:   { description: 'Enddatum (YYYY-MM-DD)', required: true }
  schedule:
    - cron: '0 8 * * *'  # tÃ¤glich 03:00 UTC

jobs:
  download-and-feature:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        symbol: [BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, XRPUSDT, ENAUSDT]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with: { python-version: '3.12' }
      - run: pip install --upgrade pandas pyarrow scipy

      - name: Calc dates
        id: dates
        run: |
          echo "global_start=2025-01-01" >> $GITHUB_OUTPUT
          echo "today=$(date -I)"        >> $GITHUB_OUTPUT

      - name: Download & unzip
        shell: bash
        run: |
          SYMBOL=${{ matrix.symbol }}
          SDG=${{ steps.dates.outputs.global_start }}
          ED=${{ steps.dates.outputs.today }}
          case "$SYMBOL" in
            BTCUSDT|ETHUSDT|BNBUSDT|SOLUSDT) INC="2023-01-01" ;;
            XRPUSDT)                         INC="2023-01-06" ;;
            ENAUSDT)                         INC="2024-04-02" ;;
            *)                               INC=$SDG ;;
          esac
          # effective start = max(resume, inception)
          # resume logic in Python script, here just download whole window:
          DIR=data/bookDepth/$SYMBOL; mkdir -p "$DIR"
          CUR=$SDG
          while [[ "$CUR" < "$ED" || "$CUR" == "$ED" ]]; do
            ZIP="$SYMBOL-bookDepth-$CUR.zip"
            curl -sSf "https://data.binance.vision/data/futures/um/daily/bookDepth/$SYMBOL/$ZIP" -o "$ZIP" \
              && unzip -q -o "$ZIP" -d "$DIR" && rm -f "$ZIP" \
              || ( echo "âš ï¸ Missing $ZIP"; rm -f "$ZIP" )
            CUR=$(date -I -d "$CUR +1 day")
          done

      - name: Feature extraction & merge
        run: |
          OUT=historical_tech/bookDepth/features/${{ matrix.symbol }}-features-\
${{ steps.dates.outputs.global_start }}_to_${{ steps.dates.outputs.today }}.parquet
          python3 extract_bookDepth_features.py \
            --input-dir data/bookDepth/${{ matrix.symbol }} \
            --start-date ${{ steps.dates.outputs.global_start }} \
            --end-date   ${{ steps.dates.outputs.today }} \
            --output-file $OUT
      - run: |
          git add historical_tech/bookDepth/features
          git commit -m "â™»ï¸ ${{ matrix.symbol }} bookDepth-Features updated to ${{ steps.dates.outputs.today }}" \
             || echo "No changes"
          git push
