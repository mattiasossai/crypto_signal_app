# .github/workflows/download_futures_data_no_bookDepth.yml

name: üì• Download & Commit Futures Data (ohne bookDepth)

on:
  workflow_dispatch:

jobs:
  download:
    name: ‚¨áÔ∏è Download ${{ matrix.category }} | ${{ matrix.symbol }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        category: [aggTrades, bookTicker, indexPriceKlines, metrics]
        symbol:   [BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, XRPUSDT, ENAUSDT]
      max-parallel: 8

    steps:
      - name: üõéÔ∏è Checkout repo
        uses: actions/checkout@v3

      - name: üîß Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl

      - name: üì• Download & Unpack ${{ matrix.category }} for ${{ matrix.symbol }}
        shell: bash
        run: |
          set -euo pipefail
          CATEGORY=${{ matrix.category }}
          SYMBOL=${{ matrix.symbol }}
          START="2020-01-01"
          END=$(date -I -d "yesterday")
          TARGET="data/futures/um/daily/${CATEGORY}/${SYMBOL}"
          mkdir -p "$TARGET"

          cur="$START"
          while [[ "$cur" < "$END" || "$cur" == "$END" ]]; do
            DATE=$(date -d "$cur" +%Y-%m-%d)
            ZIP="${SYMBOL}-${CATEGORY}-${DATE}.zip"
            URL="https://data.binance.vision/data/futures/um/daily/${CATEGORY}/${SYMBOL}/${ZIP}"
            echo "‚Üí Fetching $URL"
            if curl -sSf "$URL" -o "$TARGET/$ZIP"; then
              unzip -o "$TARGET/$ZIP" -d "$TARGET"
              rm "$TARGET/$ZIP"
              echo "   ‚úÖ unpacked $ZIP"
            else
              echo "   ‚ö†Ô∏è no file for $DATE"
            fi
            cur=$(date -I -d "$cur +1 day")
          done

      - name: üì¶ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: data-${{ matrix.category }}-${{ matrix.symbol }}
          path: data/futures/um/daily/${{ matrix.category }}/${{ matrix.symbol }}/*

  aggregate_and_push:
    name: üöÄ Aggregate & Commit All Futures Data
    runs-on: ubuntu-latest
    needs: download

    steps:
      - name: üõéÔ∏è Checkout fresh
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: üì• Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: data-artifacts

      - name: üîÄ Merge into repo
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/futures/um/daily
          find data-artifacts -type f | while read src; do
            rel=${src#data-artifacts/}
            dest="data/${rel}"
            mkdir -p "$(dirname "$dest")"
            mv "$src" "$dest"
          done

      - name: üöÄ Commit & Push
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --mixed origin/main
          git add data/futures/um/daily
          if git diff --cached --quiet; then
            echo "‚úÖ No new data to commit"
          else
            git commit -m "chore(data): import futures vision data (ohne bookDepth) [skip ci]"
            git push origin HEAD:main
          fi
