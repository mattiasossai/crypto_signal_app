name: "üì• Incremental Download & Feature aggTrades per Symbol"

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Startdatum (YYYY-MM-DD)'
        required: true
      end_date:
        description: 'Enddatum (YYYY-MM-DD)'
        required: true
  schedule:
    - cron: '0 8 * * *'  # t√§glich 03:00 UTC

jobs:
  download-and-feature:
    name: "aggTrades ${{ matrix.symbol }} (incremental)"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        symbol: [BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, XRPUSDT, ENAUSDT]
    env:
      REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO:       ${{ github.repository }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install deps
        run: pip install --upgrade pandas pyarrow

      - name: Calc global dates
        id: dates
        run: |
          echo "global_start=${{ inputs.start_date }}" >> $GITHUB_OUTPUT
          echo "global_end=${{ inputs.end_date  }}" >> $GITHUB_OUTPUT

      - name: Download & unzip raw CSVs
        run: |
          SYMBOL=${{ matrix.symbol }}
          SDG=${{ steps.dates.outputs.global_start }}
          ED=${{ steps.dates.outputs.global_end }}
          INC=$(python3 - <<'PYCODE'
import sys, json
# no-op here; inception logic only in script
print("")
PYCODE)
          mkdir -p data/aggTrades/$SYMBOL
          # always download entire window: script droppt schon Alt-Daten raus
          CUR=$SDG
          while [[ "$CUR" < "$ED" || "$CUR" == "$ED" ]]; do
            ZIP="${SYMBOL}-aggTrades-${CUR}.zip"
            curl -sSf "https://data.binance.vision/data/futures/um/daily/aggTrades/$SYMBOL/$ZIP" -o "$ZIP" && \
              unzip -p "$ZIP" > data/aggTrades/$SYMBOL/${ZIP%.zip}.csv && rm -f "$ZIP" || echo "‚ö†Ô∏è Missing $ZIP"
            CUR=$(date -I -d "$CUR +1 day")
          done

      - name: Feature extraction & append
        run: |
          mkdir -p historical_tech/aggTrades/features
          OUT=historical_tech/aggTrades/features/${{ matrix.symbol }}-features-${{ steps.dates.outputs.global_start }}_to_${{ steps.dates.outputs.global_end }}.parquet
          python3 extract_aggTrades_features_incremental.py \
            --input-dir   data/aggTrades/${{ matrix.symbol }} \
            --output-file $OUT \
            --start-date  ${{ steps.dates.outputs.global_start }} \
            --end-date    ${{ steps.dates.outputs.global_end }}

      - name: Commit & Push
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main && git checkout main
          git add historical_tech/aggTrades/features && git commit -m "‚ôªÔ∏è ${{ matrix.symbol }} aggTrades-Features up to ${{ steps.dates.outputs.global_end }}" || echo "No changes"
          git push https://x-access-token:${REPO_TOKEN}@github.com/${REPO}.git HEAD:main
