# .github/workflows/download_aggTrades.yml
name: üì• Download & Extract aggTrades per Symbol

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Globales Startdatum (YYYY-MM-DD)'
        required: true
      end_date:
        description: 'Globales Enddatum (YYYY-MM-DD)'
        required: true

jobs:
  download-and-feature:
    runs-on: self-hosted
    strategy:
      matrix:
        symbol: [BTCUSDT, ENAUSDT, BNBUSDT, ETHUSDT, SOLUSDT, XRPUSDT]
      max-parallel: 1
    env:
      REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO:       ${{ github.repository }}

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip
          python3 -m pip install --upgrade pip
          pip3 install pandas numpy pyarrow

      - name: Calculate date window
        id: dates
        shell: bash
        run: |
          echo "global_start=${{ github.event.inputs.start_date }}" >> "$GITHUB_OUTPUT"
          echo "global_end=${{ github.event.inputs.end_date }}"   >> "$GITHUB_OUTPUT"

      - name: Download & unzip raw data with Inception-Mapping & Overlap
        shell: bash
        run: |
          SYMBOL=${{ matrix.symbol }}
          SD_GLOBAL=${{ steps.dates.outputs.global_start }}
          ED=${{ steps.dates.outputs.global_end }}

          # 1) Inception-Datum w√§hlen
          case "$SYMBOL" in
            BTCUSDT|ETHUSDT) INCEP="2019-12-31" ;;
            XRPUSDT)        INCEP="2020-01-06" ;;
            BNBUSDT)        INCEP="2020-02-10" ;;
            SOLUSDT)        INCEP="2020-09-14" ;;
            ENAUSDT)        INCEP="2024-04-02" ;;
            *)              INCEP="$SD_GLOBAL" ;;
          esac

          # 2) SD = max(global_start, inception)
          t_global=$(date -d "$SD_GLOBAL" +%s)
          t_incep=$(date -d "$INCEP"     +%s)
          if [ "$t_global" -lt "$t_incep" ]; then
            SD="$INCEP"
          else
            SD="$SD_GLOBAL"
          fi

          # 3) Overlap: einen Tag vor Block-Beginn laden
          SD_RAW=$(date -I -d "$SD -1 day")

          # 4) Download & unzip bis inkl. ED
          RAW_DIR="data/aggTrades/$SYMBOL"
          mkdir -p "$RAW_DIR"
          CUR="$SD_RAW"
          while [[ "$CUR" < "$ED" || "$CUR" == "$ED" ]]; do
            ZIP="${SYMBOL}-aggTrades-${CUR}.zip"
            URL="https://data.binance.vision/data/futures/um/daily/aggTrades/${SYMBOL}/${ZIP}"
            echo "Downloading $ZIP"
            wget -q "$URL" -O "$ZIP" || echo "WARN: $ZIP missing"
            unzip -q -o "$ZIP" -d "$RAW_DIR"
            rm -f "$ZIP"
            CUR=$(date -I -d "$CUR +1 day")
          done

      - name: Run feature extraction
        shell: bash
        run: |
          SYMBOL=${{ matrix.symbol }}
          SD=${{ steps.dates.outputs.global_start }}
          ED=${{ steps.dates.outputs.global_end }}

          mkdir -p historical_tech/aggtrades/features
          python3 extract_aggTrades_features.py \
            --input-dir   "data/aggTrades/$SYMBOL" \
            --output-file "historical_tech/aggtrades/features/${SYMBOL}-features-${SD}_to_${ED}.parquet" \
            --start-date  "$SD" \
            --end-date    "$ED"

      - name: Commit & Push Feature-Parquets
        shell: bash
        run: |
          SYMBOL=${{ matrix.symbol }}
          SD=${{ steps.dates.outputs.global_start }}
          ED=${{ steps.dates.outputs.global_end }}

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "historical_tech/aggtrades/features/${SYMBOL}-features-${SD}_to_${ED}.parquet"
          git commit -m "‚ôªÔ∏è ${SYMBOL} Features ${SD} to ${ED}" || echo "No changes"
          git push "https://x-access-token:${REPO_TOKEN}@github.com/${REPO}.git" HEAD:main

      - name: Clean up raw data to free disk
        shell: bash
        run: |
          rm -rf "data/aggTrades/${{ matrix.symbol }}"
