name: ðŸ“¥ Backfill aggTrades â†’ Feature Extraction

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Startdatum fÃ¼r History (YYYY-MM-DD)'
        required: true
        default: '2020-01-01'
      end_date:
        description: 'Enddatum fÃ¼r History (YYYY-MM-DD), leer = gestern'
        required: false
        default: ''

jobs:
  backfill-aggTrades:
    runs-on: [self-hosted, linux]
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        include:
          - name: btc_ena
            symbols: [BTCUSDT, ENAUSDT]
          - name: eth_sol
            symbols: [ETHUSDT, SOLUSDT]
          - name: bnb_xrp
            symbols: [BNBUSDT, XRPUSDT]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip python3-venv wget

      - name: Create & activate Python venv
        run: |
          python3 -m venv .venv
          . .venv/bin/activate
          pip install --upgrade pip
          pip install pandas numpy pyarrow

      - name: Download & unzip aggTrades for ${{ matrix.name }}
        run: |
          START="${{ github.event.inputs.start_date }}"
          END="${{ github.event.inputs.end_date }}"
          if [ -z "$END" ]; then END=$(date --date="yesterday" +%F); fi

          mkdir -p /tmp/agg
          cd /tmp/agg

          for S in "${{ matrix.symbols[@] }}"; do
            mkdir -p "$S"
            current="$START"
            while [[ "$current" < "$END" ]] || [[ "$current" == "$END" ]]; do
              ZIP="${S}-aggTrades-${current}.zip"
              URL="https://data.binance.vision/data/futures/um/daily/aggTrades/${S}/${ZIP}"
              echo "Downloading $URL"
              if wget -q "$URL" -O "${S}/${ZIP}"; then
                unzip -o "${S}/${ZIP}" -d "${S}"
              else
                echo "WARNING: $ZIP not found, skipping"
              fi
              current=$(date --date="$current + 1 day" +%F)
            done
          done

      - name: Extract aggTrades Features for ${{ matrix.name }}
        run: |
          . .venv/bin/activate
          for S in "${{ matrix.symbols[@] }}"; do
            mkdir -p historical_tech/aggTrades/features/"$S"
            python scripts/extract_aggTrades_features.py \
              --input-dir /tmp/agg/"$S" \
              --output-file historical_tech/aggTrades/features/"$S"/aggTrades_"$S"_"${START}_to_${END}".parquet
          done

      - name: Clean up raw data for ${{ matrix.name }}
        run: rm -rf /tmp/agg

      - name: Commit & Push Features for ${{ matrix.name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git rebase origin/main
          for S in "${{ matrix.symbols[@] }}"; do
            git add historical_tech/aggTrades/features/"$S"/*.parquet
          done
          git diff --cached --quiet || git commit -m "aggTrades Features ${{ matrix.symbols[0] }}+${{ matrix.symbols[1] }} ${START}_to_${END}"
          git push origin HEAD:main
