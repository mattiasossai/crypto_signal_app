name: ðŸ“¥ Download & Extract 6-Month aggTrades

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Startdatum (YYYY-MM-DD)'
        required: true
      end_date:
        description: 'Enddatum (YYYY-MM-DD)'
        required: true
  # optional spÃ¤ter wieder aktivieren:
  # schedule:
  #   - cron: '0 2 1 */6 *'

jobs:
  download-and-features:
    runs-on: self-hosted
    env:
      REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO:       ${{ github.repository }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate date window
        id: dates
        shell: bash
        run: |
          # wir Ã¼bernehmen exakt, was der Benutzer eingegeben hat
          echo "start=${{ github.event.inputs.start_date }}" >> $GITHUB_OUTPUT
          echo "end=${{ github.event.inputs.end_date }}"     >> $GITHUB_OUTPUT

      - name: Download 6-Monats-Daten
        shell: bash
        run: |
          SD=${{ steps.dates.outputs.start }}
          ED=${{ steps.dates.outputs.end }}
          mkdir -p data/agg && cd data/agg
          SYMBOLS=(BTCUSDT ENAUSDT BNBUSDT ETHUSDT SOLUSDT XRPUSDT)

          CUR=$SD
          while [[ "$CUR" < "$ED" ]]; do
            for S in "${SYMBOLS[@]}"; do
              ZIP="${S}-aggTrades-${CUR}.zip"
              URL="https://data.binance.vision/data/futures/um/daily/aggTrades/${S}/${ZIP}"
              echo "Downloading $ZIP"
              wget -q "$URL" -O "$ZIP" || echo "WARN: $ZIP fehlt"
            done
            # hier darf 'date -I -d' stehen, aber **nicht** in den ${{â€¦}}-AusdrÃ¼cken
            CUR=$(date -I -d "$CUR +1 day")
          done

      - name: Run feature extraction
        run: |
          python3 extract_aggTrades_features.py \
            --input-dir   data/agg \
            --output-file data/features/agg_${{ steps.dates.outputs.start }}_to_${{ steps.dates.outputs.end }}.parquet

      - name: Clean up raw data to free disk
        run: rm -rf data/agg/*

      - name: Commit & Push Feature-Parquets
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/features
          git commit -m "â™»ï¸ Features ${{ steps.dates.outputs.start }} bis ${{ steps.dates.outputs.end }}"
          git push https://x-access-token:${REPO_TOKEN}@github.com/${REPO}.git HEAD:main
