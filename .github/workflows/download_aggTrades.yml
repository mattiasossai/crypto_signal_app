name: 'üì• Download & Extract aggTrades per Symbol'

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Startdatum (YYYY-MM-DD) f√ºr 6-Monats-Fenster'
        required: true
      end_date:
        description: 'Enddatum (YYYY-MM-DD) f√ºr 6-Monats-Fenster'
        required: true

jobs:
  download-and-feature:
    runs-on: runs-on: ubuntu-latest
    strategy:
      matrix:
        symbol: [BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, XRPUSDT, ENAUSDT]
      max-parallel: 1
    env:
      REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO:       ${{ github.repository }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl
          pip3 install --upgrade pip pandas numpy pyarrow

      - name: Calc dates
        id: dates
        run: |
          echo "global_start=${{ inputs.start_date }}" >> $GITHUB_OUTPUT
          echo "global_end=${{ inputs.end_date   }}" >> $GITHUB_OUTPUT

      - name: Download & unzip raw data with Overlap & Inception
        shell: bash
        run: |
          SYMBOL=${{ matrix.symbol }}
          SDG=${{ steps.dates.outputs.global_start }}
          ED=${{ steps.dates.outputs.global_end }}

          # 1) Initiales Inception-Datum
          case "$SYMBOL" in
            BTCUSDT|ETHUSDT) INC=2019-12-31;;
            XRPUSDT)         INC=2020-01-06;;
            BNBUSDT)         INC=2020-02-10;;
            SOLUSDT)         INC=2020-09-14;;
            ENAUSDT)         INC=2024-04-02;;
            *)               INC=$SDG;;
          esac

          # 2) F√ºr alle au√üer BTCUSDT: INC solange um 1 Tag hochsetzen,
          #    bis die erste Zip existiert
          if [ "$SYMBOL" != "BTCUSDT" ]; then
            CANDIDATE="$INC"
            while true; do
              ZIPFILE="${SYMBOL}-aggTrades-${CANDIDATE}.zip"
              URL="https://data.binance.vision/data/futures/um/daily/aggTrades/${SYMBOL}/${ZIPFILE}"
              if curl -sSf "$URL" -o /dev/null; then
                INC="$CANDIDATE"
                break
              else
                CANDIDATE=$(date -I -d "$CANDIDATE +1 day")
              fi
            done
          fi

          # 3) SD = max(global_start, INC)
          tg=$(date -d"$SDG" +%s); ti=$(date -d"$INC" +%s)
          [ $tg -lt $ti ] && SD=$INC || SD=$SDG

          # 4) Overlap-Tag
          SD_RAW=$(date -I -d "$SD -1 day")
          DIR=data/aggTrades/$SYMBOL
          mkdir -p "$DIR"

          # 5) Tages-Loop
          CUR="$SD_RAW"
          while [[ "$CUR" < "$ED" || "$CUR" == "$ED" ]]; do
            ZIP="${SYMBOL}-aggTrades-${CUR}.zip"
            URL="https://data.binance.vision/data/futures/um/daily/aggTrades/${SYMBOL}/${ZIP}"
            echo "‚Üí Fetching $ZIP"
            if curl -sSf "$URL" -o "$ZIP"; then
              unzip -q -o "$ZIP" -d "$DIR" && rm -f "$ZIP"
            else
              echo "‚ö†Ô∏è Missing $ZIP ‚Äì skipping"
              rm -f "$ZIP" || true
            fi
            CUR=$(date -I -d "$CUR +1 day")
          done

      - name: Feature extraction
        run: |
          mkdir -p historical_tech/aggTrades/features
          if ls data/aggTrades/${{ matrix.symbol }}/*.csv >/dev/null 2>&1; then
            python3 extract_aggTrades_features.py \
              --input-dir   data/aggTrades/${{ matrix.symbol }} \
              --output-file historical_tech/aggTrades/features/${{ matrix.symbol }}-features-${{ steps.dates.outputs.global_start }}_to_${{ steps.dates.outputs.global_end }}.parquet \
              --start-date  ${{ steps.dates.outputs.global_start }} \
              --end-date    ${{ steps.dates.outputs.global_end }}
          else
            echo "‚ö†Ô∏è No CSVs for ${{ matrix.symbol }}, skipping"
          fi

      - name: Commit & Push
        run: |
          git config user.name  github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          git add historical_tech/aggTrades/features
          git commit -m "‚ôªÔ∏è ${{ matrix.symbol }} Features ${{ steps.dates.outputs.global_start }} to ${{ steps.dates.outputs.global_end }}" || echo "No changes"
          git push https://x-access-token:${REPO_TOKEN}@github.com/${REPO}.git HEAD:main

      - name: Cleanup raw
        run: rm -rf data/aggTrades/${{ matrix.symbol }}
