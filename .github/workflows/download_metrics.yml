name: 📊 Download Metrics (ab 2020)

on:
  workflow_dispatch:

env:
  # hinterleg in Deinen Repo-Secrets → CF_PROXY_URL
  WORKER_URL: ${{ secrets.CF_PROXY_URL }}

jobs:
  download-2020-2022:
    name: 🔹 2020→2022 Metrics
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: ⚙️ Script ausführbar machen
        run: chmod +x metrics/download_metrics_range.sh

      - name: 📅 Datum setzen 2020–2022
        run: |
          echo "START=2020-01-01" >> $GITHUB_ENV
          echo "END=2022-01-01"   >> $GITHUB_ENV
          echo "PART=part1"       >> $GITHUB_ENV

      - name: 🌐 Download Metrics 2020–2022
        run: ./metrics/download_metrics_range.sh "$START" "$END" "$PART"

      - name: 📦 Zip & keine leeren Ordner
        run: |
          mkdir -p artifacts
          shopt -s globstar nullglob
          DIR=metrics/${PART}
          files=( "$DIR"/**/*.json )
          if (( ${#files[@]} )); then
            zip -j artifacts/metrics-${PART}-2020-2022.zip "${files[@]}"
            echo "→ metrics-${PART}-2020-2022.zip (${#files[@]} files)"
          else
            echo "⏩ Keine Metrics für $DIR"
          fi

      - name: 🚀 Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: metrics-2020-2022
          path: artifacts/metrics-part1-2020-2022.zip

  download-2022-now:
    name: 🔹 2022→gestern Metrics
    needs: download-2020-2022
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: ⚙️ Script ausführbar machen
        run: chmod +x metrics/download_metrics_range.sh

      - name: 📅 Datum setzen 2022–gestern
        run: |
          echo "START=2022-01-01" >> $GITHUB_ENV
          echo "END=$(date -I -d 'yesterday')" >> $GITHUB_ENV
          echo "PART=part2"                      >> $GITHUB_ENV

      - name: 🌐 Download Metrics 2022–gestern
        run: ./metrics/download_metrics_range.sh "$START" "$END" "$PART"

      - name: 📦 Zip & keine leeren Ordner
        run: |
          mkdir -p artifacts
          shopt -s globstar nullglob
          DIR=metrics/${PART}
          files=( "$DIR"/**/*.json )
          if (( ${#files[@]} )); then
            zip -j artifacts/metrics-${PART}-2022-gestern.zip "${files[@]}"
            echo "→ metrics-${PART}-2022-gestern.zip (${#files[@]} files)"
          else
            echo "⏩ Keine Metrics für $DIR"
          fi

      - name: 🚀 Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: metrics-2022-gestern
          path: artifacts/metrics-part2-2022-gestern.zip

