name: Download 4yr Metrics via Proxy

on:
  workflow_dispatch:

jobs:
  download_metrics:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        metric: [open_interest, funding_rate, liquidity]
        part: [part1, part2]
    max-parallel: 1

    env:
      # Hier deine Render-Proxy-URL
      PROXY_URL: https://crypto-signal-app.onrender.com

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download metrics via proxy
        shell: bash
        run: |
          # Errechne START/END je nach part1/part2
          if [[ "${{ matrix.part }}" == "part1" ]]; then
            START="2020-01-01"
            END="2022-12-31"
          else
            START="2023-01-01"
            END=$(date -I -d "yesterday")
          fi

          chmod +x metrics/download_metrics_range.sh
          # Aufruf mit METRIC START END PART
          PROXY_URL="${PROXY_URL}" \
            metrics/download_metrics_range.sh \
              "${{ matrix.metric }}" \
              "$START" \
              "$END" \
              "${{ matrix.part }}"
