name: ğŸ“Š Download 4yr Metrics (3Ã—2 parallel jobs)

on:
  workflow_dispatch:

jobs:
  open_interest:
    name: ğŸ”„ Open Interest â†’ ${{ matrix.part }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        part: [part1, part2]

    steps:
      - name: ğŸ”€ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸŒ Set WORKER_URL
        run: echo "WORKER_URL=${{ secrets.METRICS_WORKER_URL }}" >> $GITHUB_ENV

      - name: ğŸ› ï¸ Make script executable
        run: chmod +x metrics/download_metrics_range.sh

      - name: ğŸ“… Compute date range
        run: |
          if [ "${{ matrix.part }}" = "part1" ]; then
            START="2020-01-01"
            END="2022-01-01"
          else
            START="2022-01-01"
            END="$(date -I -d "yesterday")"
          fi
          echo "START=$START" >> $GITHUB_ENV
          echo "END=$END"     >> $GITHUB_ENV

      - name: ğŸŒ Download open_interest JSONs
        run: |
          ./metrics/download_metrics_range.sh \
            open_interest \
            "$START" \
            "$END" \
            "${{ matrix.part }}"

      - name: ğŸ”„ Commit & Push open_interest JSONs
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git rebase origin/main
          git add -A metrics/${{ matrix.part }}/open_interest
          if ! git diff --cached --quiet; then
            git commit -m "feat(metrics): add open_interest part=${{ matrix.part }} up to $(date -I) [skip ci]"
            git push origin HEAD:main
          else
            echo "â†’ No new open_interest for ${{ matrix.part }}"
          fi

  funding_rate:
    name: ğŸ”„ Funding Rate â†’ ${{ matrix.part }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        part: [part1, part2]

    steps:
      - name: ğŸ”€ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸŒ Set WORKER_URL
        run: echo "WORKER_URL=${{ secrets.METRICS_WORKER_URL }}" >> $GITHUB_ENV

      - name: ğŸ› ï¸ Make script executable
        run: chmod +x metrics/download_metrics_range.sh

      - name: ğŸ“… Compute date range
        run: |
          if [ "${{ matrix.part }}" = "part1" ]; then
            START="2020-01-01"
            END="2022-01-01"
          else
            START="2022-01-01"
            END="$(date -I -d "yesterday")"
          fi
          echo "START=$START" >> $GITHUB_ENV
          echo "END=$END"     >> $GITHUB_ENV

      - name: ğŸŒ Download funding_rate JSONs
        run: |
          ./metrics/download_metrics_range.sh \
            funding_rate \
            "$START" \
            "$END" \
            "${{ matrix.part }}"

      - name: ğŸ”„ Commit & Push funding_rate JSONs
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git rebase origin/main
          git add -A metrics/${{ matrix.part }}/funding_rate
          if ! git diff --cached --quiet; then
            git commit -m "feat(metrics): add funding_rate part=${{ matrix.part }} up to $(date -I) [skip ci]"
            git push origin HEAD:main
          else
            echo "â†’ No new funding_rate for ${{ matrix.part }}"
          fi

  liquidity:
    name: ğŸ”„ Liquidity â†’ ${{ matrix.part }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        part: [part1, part2]

    steps:
      - name: ğŸ”€ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸŒ Set WORKER_URL
        run: echo "WORKER_URL=${{ secrets.METRICS_WORKER_URL }}" >> $GITHUB_ENV

      - name: ğŸ› ï¸ Make script executable
        run: chmod +x metrics/download_metrics_range.sh

      - name: ğŸ“… Compute date range
        run: |
          if [ "${{ matrix.part }}" = "part1" ]; then
            START="2020-01-01"
            END="2022-01-01"
          else
            START="2022-01-01"
            END="$(date -I -d "yesterday")"
          fi
          echo "START=$START" >> $GITHUB_ENV
          echo "END=$END"     >> $GITHUB_ENV

      - name: ğŸŒ Download liquidity JSONs
        run: |
          ./metrics/download_metrics_range.sh \
            liquidity \
            "$START" \
            "$END" \
            "${{ matrix.part }}"

      - name: ğŸ”„ Commit & Push liquidity JSONs
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git rebase origin/main
          git add -A metrics/${{ matrix.part }}/liquidity
          if ! git diff --cached --quiet; then
            git commit -m "feat(metrics): add liquidity part=${{ matrix.part }} up to $(date -I) [skip ci]"
            git push origin HEAD:main
          else
            echo "â†’ No new liquidity for ${{ matrix.part }}"
          fi
