name: Download & Commit Metrics via Proxy

on:
  workflow_dispatch:

jobs:
  download:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        metric: [open_interest, funding_rate, liquidity]
        part:   [part1, part2]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download JSONs via Proxy
        shell: bash
        env:
          PROXY_URL: ${{ vars.PROXY_URL }}
        run: |
          chmod +x metrics/download_metrics_range.sh

          if [[ "${{ matrix.part }}" == "part1" ]]; then
            START="2020-01-01"
            END="2022-12-31"
          else
            START="2023-01-01"
            END=$(date -I -d "yesterday")
          fi

          echo "â†’ Downloading ${{ matrix.metric }} | ${{ matrix.part }} @ $START â†’ $END"
          PROXY_URL="${PROXY_URL}" \
            metrics/download_metrics_range.sh \
              "${{ matrix.metric }}" \
              "$START" \
              "$END" \
              "${{ matrix.part }}"

      - name: Upload JSON-Artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: metrics-${{ matrix.metric }}-${{ matrix.part }}
          path: metrics/${{ matrix.part }}/${{ matrix.metric }}/*.json

      - name: Aggregate & Push Metrics
        if: ${{ always() }}
        shell: bash
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          # holâ€™ frischen Stand
          git fetch origin main
          git reset --mixed origin/main

          # nur die neuen/ geÃ¤nderten JSONs hinzufÃ¼gen
          git add metrics/${{ matrix.part }}/${{ matrix.metric }}/*.json

          if ! git diff --cached --quiet; then
            git commit -m "chore(metrics): update ${{ matrix.metric }}/${{ matrix.part }} [skip ci]"
            git push origin HEAD:main
          else
            echo "ðŸš€ Keine Ã„nderungen fÃ¼r ${{ matrix.metric }}/${{ matrix.part }}"
          fi
