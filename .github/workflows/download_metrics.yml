name: ðŸ“Š Download 4yr Metrics (6 Jobs)

on:
  workflow_dispatch:

jobs:
  download:
    name: ðŸ”„ ${{ matrix.metric }} âž¡ï¸ ${{ matrix.part }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        metric: [open_interest, funding_rate, liquidity]
        part:   [part1, part2]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set WORKER_URL
        run: echo "WORKER_URL=${{ secrets.METRICS_WORKER_URL }}" >> $GITHUB_ENV

      - name: Make script executable
        run: chmod +x metrics/download_metrics_range.sh

      - name: Compute date range for ${{ matrix.part }}
        shell: bash
        run: |
          if [ "${{ matrix.part }}" = "part1" ]; then
            START="2020-01-01"
            END="2022-01-01"
          else
            START="2022-01-01"
            END="$(date -I -d "yesterday")"
          fi
          echo "START=$START" >> $GITHUB_ENV
          echo "END=$END"     >> $GITHUB_ENV

      - name: Download metrics: ${{ matrix.metric }}
        run: |
          # Script lÃ¤dt zwar alle 3 Metriken, wir zippen aber nur die eine, die wir hier brauchen
          ./metrics/download_metrics_range.sh "$START" "$END" ${{ matrix.part }}

      - name: Zip only "${{ matrix.metric }}"
        run: |
          mkdir -p artifacts
          ZIP=artifacts/metrics-${{ matrix.metric }}-${{ matrix.part }}.zip
          DIR=metrics/${{ matrix.part }}/${{ matrix.metric }}
          echo "â†’ Zipping $DIR â†’ $ZIP"
          zip -j "$ZIP" "$DIR"/*.json

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: metrics-${{ matrix.metric }}-${{ matrix.part }}
          path: artifacts/metrics-${{ matrix.metric }}-${{ matrix.part }}.zip
