name: Download 4yr Metrics via Proxy (parallel)

on:
  workflow_dispatch:

jobs:
  download_metrics:
    # Klarer Job-Name f√ºr die Actions-UI
    name: Download ${{ matrix.metric }} | ${{ matrix.part }} | ${{ matrix.symbol }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        metric: [open_interest, funding_rate, liquidity]
        part:   [part1, part2]
        # Nur die 6 gew√ºnschten Symbole
        symbol: [BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, XRPUSDT, ENAUSDT]
      max-parallel: 36  # alle Kombis gleichzeitig

    env:
      # DEINE neue Proxy-URL hier:
      PROXY_URL: https://crypto-signal-app-1.onrender.com
      GIT_USER: github-actions[bot]
      GIT_EMAIL: github-actions[bot]@users.noreply.github.com

    steps:
      - name: Checkout mit Schreibrechten
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: jq installieren
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Metrics herunterladen
        shell: bash
        run: |
          # Part1 oder Part2 definieren
          if [[ "${{ matrix.part }}" == "part1" ]]; then
            START="2020-01-01"
            END="2022-12-31"
          else
            START="2023-01-01"
            END=$(date -I -d "yesterday")
          fi

          chmod +x metrics/download_metrics_range.sh

          PROXY_URL="${PROXY_URL}" \
            metrics/download_metrics_range.sh \
              "${{ matrix.metric }}" \
              "$START" \
              "$END" \
              "${{ matrix.part }}" \
              "${{ matrix.symbol }}"

      - name: √Ñnderungen committen & pushen (robust)
        shell: bash
        run: |
          git config user.name "${GIT_USER}"
          git config user.email "${GIT_EMAIL}"

          # Immer auf aktuellen Remote-Stand setzen, lokale Dateien bleiben erhalten
          git fetch origin main
          git reset --mixed origin/main

          # Stage alle neuen/ge√§nderten JSONs f√ºr dieses Symbol/Metric/Part
          git add metrics/${{ matrix.part }}/${{ matrix.metric }}/${{ matrix.symbol }}_*.json

          # Commit & Push nur, wenn √Ñnderungen vorliegen
          if ! git diff --cached --quiet; then
            git commit -m "chore(metrics): update ${{ matrix.metric }}/${{ matrix.part }}/${{ matrix.symbol }} [skip ci]"
            git push origin HEAD:main
          else
            echo "üöÄ Keine √Ñnderungen f√ºr ${{ matrix.metric }}/${{ matrix.part }}/${{ matrix.symbol }}"
          fi
