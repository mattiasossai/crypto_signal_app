name: ğŸ“ˆ Download & Commit 4yr Metrics via Proxy

on:
  workflow_dispatch:

jobs:
  download_matrix:
    name: ğŸ”„ Download ${{ matrix.metric }} | ${{ matrix.part }} | ${{ matrix.symbol }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        metric: [open_interest, funding_rate]
        part:   [part1, part2]
        symbol: [BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, XRPUSDT, ENAUSDT]
      max-parallel: 24

    env:
      PROXY_URL: ${{ secrets.RAILWAY_PROXY_URL }}

    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v3

      - name: ğŸ”§ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip

      - name: ğŸ“Š Download Metrics via Proxy
        shell: bash
        run: |
          chmod +x metrics/download_metrics_range.sh

          if [[ "${{ matrix.part }}" == "part1" ]]; then
            START="2020-01-01"
            END="2022-12-31"
          else
            START="2023-01-01"
            END=$(date -I -d "yesterday")
          fi

          echo "â†’ Downloading ${{ matrix.metric }} | ${{ matrix.part }} | ${{ matrix.symbol }} from $START to $END"
          metrics/download_metrics_range.sh \
            "${{ matrix.metric }}" \
            "$START" \
            "$END" \
            "${{ matrix.part }}" \
            "${{ matrix.symbol }}"

      - name: ğŸ“¦ Upload JSON-Artifact
        uses: actions/upload-artifact@v4
        with:
          name: metrics-${{ matrix.metric }}-${{ matrix.part }}-${{ matrix.symbol }}
          path: metrics/${{ matrix.part }}/${{ matrix.metric }}/${{ matrix.symbol }}/*.json
          if-no-files-found: ignore

  aggregate_and_push:
    name: ğŸš€ Aggregate & Push Metrics
    runs-on: ubuntu-latest
    needs: download_matrix

    env:
      GIT_USER: github-actions[bot]
      GIT_EMAIL: github-actions[bot]@users.noreply.github.com

    steps:
      - name: ğŸ›ï¸ Checkout fresh
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: ğŸ“¥ Download all metric-artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./metrics-artifacts

      - name: ğŸ§¹ Clean old metrics folders
        run: |
          rm -rf metrics/part1 metrics/part2
          mkdir -p metrics/part1 metrics/part2

      - name: ğŸ”€ Copy artifacts into metrics/
        run: |
          find metrics-artifacts -type f -name '*.json' | while read src; do
            rel="${src#metrics-artifacts/}"
            dst="metrics/${rel}"
            mkdir -p "$(dirname "$dst")"
            mv "$src" "$dst"
          done

      - name: ğŸ“ˆ Commit & Push all Metrics
        shell: bash
        run: |
          git config user.name "${GIT_USER}"
          git config user.email "${GIT_EMAIL}"
          git fetch origin main
          git reset --mixed origin/main
          git add metrics
          if ! git diff --cached --quiet; then
            git commit -m "chore(metrics): full re-download [skip ci]"
            git push origin HEAD:main
          else
            echo "ğŸš€ No changes after metrics download"
          fi
