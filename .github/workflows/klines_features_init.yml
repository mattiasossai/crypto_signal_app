name: ðŸŸ£ Klines Features Matrix Extraction

on:
  workflow_dispatch:

jobs:
  extract_klines_features:
    name: Extract Features ${{ matrix.symbol }} @ ${{ matrix.interval }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        symbol: [BTCUSDT, ETHUSDT, BNBUSDT, XRPUSDT, SOLUSDT, ENAUSDT]
        interval: [1m, 5m, 15m, 1h, 4h]
      max-parallel: 1
      fail-fast: false
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install TA-Lib system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libtool libffi-dev ruby ruby-dev make
          sudo apt-get install -y python3-dev
          sudo apt-get install -y libopenblas-dev
          sudo apt-get install -y liblapack-dev
          sudo apt-get install -y gfortran
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzvf ta-lib-0.4.0-src.tar.gz
          cd ta-lib
          ./configure --prefix=/usr
          make
          sudo make install
          cd ..

      - name: Install Python dependencies
        run: |
          pip install "numpy<1.24"
          pip install pandas pyarrow pandas-ta --upgrade
          pip install TA-Lib
          
      - name: Run Klines Feature Extraction
        run: |
          echo "Extracting features for ${{ matrix.symbol }} / ${{ matrix.interval }}"
          python train/extract_klines_features.py --symbol ${{ matrix.symbol }} --interval ${{ matrix.interval }}
      - name: Commit and push features
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'actions@github.com'
          git add features/klines/${{ matrix.symbol }}/${{ matrix.interval }}/features-${{ matrix.symbol }}-${{ matrix.interval }}.parquet
          git commit -m "Features for ${{ matrix.symbol }}-${{ matrix.interval }}"
          git push
        continue-on-error: true
