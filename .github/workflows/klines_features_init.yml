name: 🟣 Klines Features Matrix Extraction

on:
  workflow_dispatch:

jobs:
  extract_klines_features:
    name: Extract Features ${{ matrix.symbol }} @ ${{ matrix.interval }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        symbol:   [BTCUSDT, ETHUSDT, BNBUSDT, XRPUSDT, SOLUSDT, ENAUSDT]
        interval: [1m, 5m, 15m, 1h, 4h]
      max-parallel: 1
      fail-fast: false

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-cache

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build TA-Lib from source
        run: |
          sudo apt-get update
          sudo apt-get install -y wget build-essential automake autoconf libtool pkg-config
          wget https://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzf ta-lib-0.4.0-src.tar.gz
          cd ta-lib
          ./configure --prefix=/usr     # install libs into /usr/lib
          make
          sudo make install
          sudo ldconfig
          # create symlink so that Python wrapper finds "-lta-lib"
          sudo ln -sf /usr/lib/libta_lib.so /usr/lib/libta-lib.so
          cd ..

      - name: Install Python dependencies
        run: |
          pip install "numpy<1.24"
          pip install pandas pyarrow pandas-ta --upgrade
          pip install TA-Lib

      - name: List raw CSVs
        run: ls -R raw/klines/${{ matrix.symbol }} | sed 's/^/  /'

      - name: Run Klines Feature Extraction
        run: |
          echo "Extracting features for ${{ matrix.symbol }} / ${{ matrix.interval }}"
          python train/extract_klines_features.py --symbol ${{ matrix.symbol }} --interval ${{ matrix.interval }}

      - name: Commit and push features
        run: |
          git add features/klines/${{ matrix.symbol }}/${{ matrix.interval }}/features-${{ matrix.symbol }}-${{ matrix.interval }}.parquet
          if git diff --cached --quiet; then
            echo "✔️ No changes to commit"
          else
            git config user.name 'github-actions'
            git config user.email 'actions@github.com'
            git commit -m "Features for ${{ matrix.symbol }}-${{ matrix.interval }}"
            git push
          fi
        continue-on-error: true
