name: ğŸ‹ï¸â€â™‚ï¸ Full Pipeline: Download & Train

on:
  workflow_dispatch:

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1) Artifacts herunterladen
  download_artifacts:
    name: ğŸ“¥ Download Candles + Metrics Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout repo
        uses: actions/checkout@v3

      - name: ğŸ“¦ Download Candlestick Artifacts
        uses: actions/download-artifact@v4
        with:
          name: history-*
          path: historical_raw/

      - name: ğŸ“Š Download Metrics Artifacts
        uses: actions/download-artifact@v4
        with:
          name: metrics-*
          path: metrics_raw/

      - name: âœ… Mark artifacts ready
        run: echo "ARTIFACTS_DOWNLOADED=true" >> $GITHUB_ENV

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2) Artifacts entpacken
  prepare_data:
    name: ğŸ—‚ï¸ Unzip Historical & Metrics
    runs-on: ubuntu-latest
    needs: download_artifacts
    steps:
      - name: ğŸ”„ Checkout repo
        uses: actions/checkout@v3

      - name: ğŸ”§ Unzip Candlestick-Zips
        run: |
          mkdir -p historical
          for Z in historical_raw/*.zip; do
            unzip -q "$Z" -d historical/
          done

      - name: ğŸ”§ Unzip Metrics-Zips
        run: |
          mkdir -p metrics
          for Z in metrics_raw/*.zip; do
            unzip -q "$Z" -d metrics/
          done

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3) Trainieren und TFLite erzeugen
  train_model:
    name: ğŸ¤– Train & Export TFLite
    runs-on: ubuntu-latest
    needs: prepare_data
    steps:
      - name: ğŸ”„ Checkout repo
        uses: actions/checkout@v3

      - name: âš™ï¸ Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ğŸ“¥ Install training dependencies
        run: pip install -r train/requirements.txt

      - name: â–¶ï¸ Run training script
        working-directory: train
        run: python train.py

      - name: ğŸš€ Upload model artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-files
          path: |
            train/scaler.pkl
            train/model.tflite
