name: ðŸ“¥ Download Rolling History (last 30d)

on:
  workflow_dispatch:

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1. Fan-Out: pro SymbolÃ—Interval ein Job, lÃ¤dt CSVs der letzten 30 Tage hoch
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  download_matrix:
    name: ðŸ“¥ History | ${{ matrix.symbol }} | ${{ matrix.interval }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        symbol:   [BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, XRPUSDT, ENAUSDT]
        interval: [1m,5m,15m,1h,4h]
      max-parallel: 12

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Download last 30 days of history
        shell: bash
        run: |
          chmod +x historical/download_history_range.sh
          # heutiges Datum
          END=$(date -I)
          # 30 Tage davor
          START=$(date -I -d "$END -30 days")
          # Script lÃ¤dt inclusive END
          historical/download_history_range.sh \
            "${{ matrix.symbol }}" \
            "${{ matrix.interval }}" \
            "$START" \
            "$END"

      - name: Upload CSV-Artifact
        uses: actions/upload-artifact@v4
        with:
          name: history-${{ matrix.symbol }}-${{ matrix.interval }}
          path: historical/${{ matrix.symbol }}/${{ matrix.interval }}/*.csv
          if-no-files-found: ignore

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. Fan-In: sammelt alle CSV-Artefakte ein, merged sie ins Repo und pusht
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  aggregate_and_push:
    name: ðŸ“¦ Aggregate & Push History
    runs-on: ubuntu-latest
    needs: download_matrix
    if: needs.download_matrix.result == 'success'

    env:
      GIT_USER: github-actions[bot]
      GIT_EMAIL: github-actions[bot]@users.noreply.github.com

    steps:
      - name: Checkout fresh
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Download all history-artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./history-artifacts

      - name: Clean rolling folders
        run: |
          # wir halten nur den Unterordner part2/rolling
          rm -rf historical/*/*/rolling
          mkdir -p historical

      - name: Copy artifacts into historical/
        run: |
          find history-artifacts -type f -name '*.csv' | while read src; do
            # src = history-artifacts/<symbol>-<interval>/<file>.csv
            # wir extrahieren symbol und interval
            base=$(basename "$(dirname "$src")")
            symbol="${base%%-*}"
            interval="${base#*-}"
            dst="historical/${symbol}/${interval}/$(basename "$src")"
            mkdir -p "$(dirname "$dst")"
            mv "$src" "$dst"
          done

      - name: Commit & Push all History
        shell: bash
        run: |
          git config user.name "${GIT_USER}"
          git config user.email "${GIT_EMAIL}"
          git fetch origin main
          git reset --mixed origin/main
          git add historical
          if ! git diff --cached --quiet; then
            git commit -m "chore(history): rolling last 30d [skip ci]"
            git push origin HEAD:main
          else
            echo "ðŸš€ Keine Ã„nderungen bei History"
          fi
