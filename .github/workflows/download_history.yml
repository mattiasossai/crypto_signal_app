name: ðŸ“¥ Download Rolling History (last 30d)

on:
  workflow_dispatch:

jobs:
  download_history:
    name: History | ${{ matrix.symbol }} | ${{ matrix.interval }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        symbol:   [BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, XRPUSDT, ENAUSDT]
        interval: [1m,5m,15m,1h,4h]
      max-parallel: 24  # 6 Symbole Ã— 4 Intervalle parallel

    env:
      GIT_USER: github-actions[bot]
      GIT_EMAIL: github-actions[bot]@users.noreply.github.com

    steps:
      - name: Checkout mit Schreibrechten
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Tools installieren
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip jq

      - name: History herunterladen
        shell: bash
        run: |
          chmod +x historical/download_history_range.sh
          historical/download_history_range.sh \
            "${{ matrix.symbol }}" \
            "${{ matrix.interval }}"

      - name: Ã„nderungen committen & pushen (robust)
        shell: bash
        run: |
          git config user.name "${GIT_USER}"
          git config user.email "${GIT_EMAIL}"

          # 1) Neueste Remote-Commits holen
          git fetch origin main
          # 2) Arbeitskopie & Index auf remote/main setzen (lokale neuen CSVs bleiben erhalten)
          git reset --mixed origin/main

          # 3) Nur neue/ geÃ¤nderte CSVs fÃ¼r dieses Symbol/Intervall stage-en
          git add historical/${{ matrix.symbol }}/${{ matrix.interval }}/*.csv

          # 4) Commit + Push, wenn es Ã„nderungen gibt
          if ! git diff --cached --quiet; then
            git commit -m "chore(history): add rolling ${{ matrix.symbol }} ${{ matrix.interval }} [skip ci]"
            git push origin HEAD:main
          else
            echo "ðŸš€ Keine neuen Dateien fÃ¼r ${{ matrix.symbol }}/${{ matrix.interval }}"
          fi
