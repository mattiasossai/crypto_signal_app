name: üì• Download Candlestick History into Repo

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - 'historical/**'

jobs:
  download:
    # Parallel f√ºr jedes SymbolÔΩúIntervalÔΩúPart
    name: üîÑ ${{ matrix.symbol }}ÔΩú${{ matrix.interval }}ÔΩú${{ matrix.part }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        symbol:   [BTCUSDT, ETHUSDT, BNBUSDT, XRPUSDT, SOLUSDT, ENAUSDT]
        interval: [1m, 5m, 15m, 1h, 4h]
        part:     [part1, part2]

    steps:
      # 1) checkout
      - name: üîÄ Checkout repository
        uses: actions/checkout@v3

      # 2) Git user konfigurieren
      - name: ‚öôÔ∏è Configure Git user
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 3) Download-Script ausf√ºhrbar machen
      - name: üîß Make download script executable
        run: chmod +x train/download_data_range.sh

      # 4) Datumsspanne berechnen
      - name: üìÖ Calculate date range for ${{ matrix.part }}
        id: dates
        run: |
          if [[ "${{ matrix.part }}" == "part1" ]]; then
            START=2020-01-01
            END=2022-01-01
          else
            START=2022-01-01
            END=$(date -I -d "yesterday")
          fi
          echo "start=$START" >> $GITHUB_OUTPUT
          echo "end=$END"   >> $GITHUB_OUTPUT

      # 5) Download der historischen Daten
      - name: üåê Download ${{ matrix.symbol }} / ${{ matrix.interval }} / ${{ matrix.part }}
        run: |
          OUT=historical/${{ matrix.symbol }}/${{ matrix.interval }}/${{ matrix.part }}
          mkdir -p "$OUT"
          ./train/download_data_range.sh \
            "${{ matrix.symbol }}" \
            "${{ matrix.interval }}" \
            "${{ steps.dates.outputs.start }}" \
            "${{ steps.dates.outputs.end }}" \
            "$OUT"

      # 6) ZIP entpacken + aufr√§umen
      - name: üìÇ Unzip & cleanup
        run: |
          DIR=historical/${{ matrix.symbol }}/${{ matrix.interval }}/${{ matrix.part }}
          for z in "$DIR"/*.zip; do
            unzip -q "$z" -d "$DIR"
          done
          rm -f "$DIR"/*.zip

      # 7) Commit & Push der neuen CSVs
      - name: üîÑ Commit & Push CSVs into repo
        run: |
          # Hol erst die aktuellste main
          git pull --rebase origin main

          # Stage alle CSVs in diesem Verzeichnis
          git add -A historical/${{ matrix.symbol }}/${{ matrix.interval }}/${{ matrix.part }}

          # Nur committen, wenn es √Ñnderungen gibt
          if ! git diff --cached --quiet; then
            git commit -m "feat(history): add ${{ matrix.symbol }} ${{ matrix.interval }} ${{ matrix.part }} CSVs up to $(date -I) [skip ci]"
            git push origin HEAD:main
          else
            echo "‚Üí No new CSVs for ${{ matrix.symbol }} / ${{ matrix.interval }} / ${{ matrix.part }}"
          fi
