name: ğŸ“¥ Download Candlestick History (Parallel)

on:
  workflow_dispatch:

jobs:
  download:
    # jeweils Symbolï½œIntervalï½œPart im Job-Namen
    name: ğŸ“¦ ${{ matrix.symbol }}ï½œ${{ matrix.interval }}ï½œ${{ matrix.part }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        symbol:   [BTCUSDT, ETHUSDT, BNBUSDT, XRPUSDT, SOLUSDT, ENAUSDT]
        interval: [1m, 5m, 15m, 1h, 4h]
        part:     [part1, part2]

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v3

      - name: âš™ï¸  Skript ausfÃ¼hrbar machen
        run: chmod +x train/download_data_range.sh

      - name: ğŸ“… Berechne Datumsspanne fÃ¼r ${{ matrix.part }}
        id: dates
        run: |
          if [[ "${{ matrix.part }}" == "part1" ]]; then
            # von Start (hier 2020-01-01) bis 2 Jahre spÃ¤ter
            START=2020-01-01
            END=2022-01-01
          else
            # von 2022-01-01 bis gestern
            START=2022-01-01
            END=$(date -I -d "yesterday")
          fi
          echo "start=$START" >> $GITHUB_OUTPUT
          echo "end=$END"   >> $GITHUB_OUTPUT

      - name: ğŸŒ Download ${{ matrix.symbol }} / ${{ matrix.interval }} / ${{ matrix.part }}
        run: |
          OUT=historical/${{ matrix.symbol }}/${{ matrix.interval }}/${{ matrix.part }}
          mkdir -p "$OUT"
          ./train/download_data_range.sh \
            "${{ matrix.symbol }}" \
            "${{ matrix.interval }}" \
            "${{ steps.dates.outputs.start }}" \
            "${{ steps.dates.outputs.end }}" \
            "$OUT"

      - name: ğŸ“¦ ZIP & Upload
        run: |
          mkdir -p artifacts
          DIR=historical/${{ matrix.symbol }}/${{ matrix.interval }}/${{ matrix.part }}
          files=( "$DIR"/*.zip )
          if (( ${#files[@]} )); then
            ZIP=artifacts/hist-${{ matrix.symbol }}-${{ matrix.interval }}-${{ matrix.part }}.zip
            zip -j "$ZIP" "${files[@]}"
            echo "â†’ $ZIP created with ${#files[@]} files"
          else
            echo "âŒ No files to zip in $DIR â€” failing job!"
            exit 1
          fi

      - name: ğŸš€ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: history-${{ matrix.symbol }}-${{ matrix.interval }}-${{ matrix.part }}
          path: artifacts/hist-${{ matrix.symbol }}-${{ matrix.interval }}-${{ matrix.part }}.zip
