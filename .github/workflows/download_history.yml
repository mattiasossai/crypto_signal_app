# .github/workflows/download_history_split_60.yml
name: ğŸ“¥ Download 4yr Historical Data (60 Jobs)

on:
  workflow_dispatch:

jobs:
  download:
    name: ğŸ”„ ${{ matrix.symbol }}ï½œ${{ matrix.interval }}ï½œ${{ matrix.part }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        symbol:   [BTCUSDT, ETHUSDT, BNBUSDT, XRPUSDT, SOLUSDT, ENAUSDT]
        interval: [1m, 5m, 15m, 1h, 4h]
        part:     [part1, part2]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ”§ Make download script executable
        run: chmod +x download_data_range.sh

      - name: ğŸ“… Compute date range for ${{ matrix.part }}
        shell: bash
        run: |
          if [ "${{ matrix.part }}" = "part1" ]; then
            START=$(date -I -d "4 years ago")
            END  =$(date -I -d "2 years ago")
          else
            START=$(date -I -d "2 years ago")
            END  =$(date -I -d "yesterday")
          fi
          echo "START=$START" >> $GITHUB_ENV
          echo "END=$END"     >> $GITHUB_ENV

      - name: ğŸŒ Download ${{ matrix.symbol }} / ${{ matrix.interval }} / ${{ matrix.part }}
        run: |
          OUT=historical/${{ matrix.symbol }}/${{ matrix.interval }}/${{ matrix.part }}
          mkdir -p "$OUT"
          ./download_data_range.sh \
            "${{ matrix.symbol }}" \
            "${{ matrix.interval }}" \
            "$START" "$END" \
            "$OUT"

      - name: ğŸ“¦ Zip downloaded files
        run: |
          mkdir -p artifacts
          ZIP=artifacts/hist-${{ matrix.symbol }}-${{ matrix.interval }}-${{ matrix.part }}.zip
          DIR=historical/${{ matrix.symbol }}/${{ matrix.interval }}/${{ matrix.part }}
          # Nur zippen, wenn Dateien existieren
          if ls "$DIR"/*.zip 1> /dev/null 2>&1; then
            echo "â¤ Zipping $DIR â†’ $ZIP"
            zip -j "$ZIP" "$DIR"/*.zip
          else
            echo "âš ï¸  No files found in $DIR â€“ skipping zip"
          fi

      - name: ğŸš€ Upload history artifact
        if: always() # lÃ¤dt nur, wenn ZIP existiert
        uses: actions/upload-artifact@v4
        with:
          name: historical-${{ matrix.symbol }}-${{ matrix.interval }}-${{ matrix.part }}
          path: artifacts/hist-${{ matrix.symbol }}-${{ matrix.interval }}-${{ matrix.part }}.zip
