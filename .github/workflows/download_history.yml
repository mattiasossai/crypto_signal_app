# .github/workflows/history_download.yml
name: ğŸ“¥ Download Candlestick History

on:
  workflow_dispatch:

jobs:
  download-history:
    name: ğŸ“¦ ${{ matrix.symbol }}ï½œ${{ matrix.interval }}ï½œ${{ matrix.part }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        symbol:   [BTCUSDT, ETHUSDT, BNBUSDT, XRPUSDT, SOLUSDT, ENAUSDT]
        interval: [1m, 5m, 15m, 1h, 4h]
        part:     [part1, part2]

    steps:
      # 1) Repository auschecken
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v3

      # 2) Download-Script ausfÃ¼hrbar machen
      - name: âš™ï¸ Skript ausfÃ¼hrbar machen
        run: chmod +x train/download_data_range.sh

      # 3) Datumsspanne berechnen
      - name: ğŸ“… Datumsspanne berechnen
        id: dates
        run: |
          if [[ "${{ matrix.part }}" == "part1" ]]; then
            echo "start=2020-01-01" >> $GITHUB_OUTPUT
            echo "end=2022-01-01"   >> $GITHUB_OUTPUT
          else
            echo "start=2022-01-01" >> $GITHUB_OUTPUT
            echo "end=$(date -I -d "yesterday")" >> $GITHUB_OUTPUT
          fi

      # 4) Zips herunterladen
      - name: ğŸŒ Download ${{ matrix.symbol }} / ${{ matrix.interval }} / ${{ matrix.part }}
        run: |
          OUT=historical/${{ matrix.symbol }}/${{ matrix.interval }}/${{ matrix.part }}
          mkdir -p "$OUT"
          ./train/download_data_range.sh \
            "${{ matrix.symbol }}" \
            "${{ matrix.interval }}" \
            "${{ steps.dates.outputs.start }}" \
            "${{ steps.dates.outputs.end }}" \
            "$OUT"

      # 5) Alle .zip-Dateien entpacken
      - name: ğŸ“¥ Unzip in ${{ matrix.symbol }}/${{ matrix.interval }}/${{ matrix.part }}
        run: |
          DIR=historical/${{ matrix.symbol }}/${{ matrix.interval }}/${{ matrix.part }}
          for z in "$DIR"/*.zip; do
            unzip -q "$z" -d "$DIR"
          done

      # 6) AufrÃ¤umen: ZIP-Dateien lÃ¶schen
      - name: ğŸ§¹ Alte ZIP-Dateien entfernen
        run: |
          DIR=historical/${{ matrix.symbol }}/${{ matrix.interval }}/${{ matrix.part }}
          rm -f "$DIR"/*.zip

