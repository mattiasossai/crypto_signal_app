# .github/workflows/download_history.yml
name: 📥 Download Candlestick History

on:
  workflow_dispatch:

jobs:
  download:
    name: 🔄 ${{ matrix.symbol }} ｜ ${{ matrix.interval }}
    runs-on: ubuntu-latest

    strategy:
      max-parallel: 1                      # <<< hier der Trick!
      matrix:
        symbol:   [BTCUSDT, ETHUSDT, BNBUSDT, XRPUSDT, SOLUSDT, ENAUSDT]
        interval: [1m, 5m, 15m, 1h, 4h]

    steps:
      - name: 🔀 Checkout full history
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ⚙️ Configure Git user
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: 🔧 Make script executable
        run: chmod +x train/download_data_range.sh

      - name: 📅 Calculate rolling 30-day window
        id: dates
        run: |
          END=$(date -I -d "yesterday")
          START=$(date -I -d "$END - 30 days")
          echo "start=$START" >> $GITHUB_OUTPUT
          echo "end=$END"     >> $GITHUB_OUTPUT

      - name: 🌐 Download 30d rolling for ${{ matrix.symbol }} / ${{ matrix.interval }}
        run: |
          OUT=historical/${{ matrix.symbol }}/${{ matrix.interval }}/rolling
          mkdir -p "$OUT"
          ./train/download_data_range.sh \
            "${{ matrix.symbol }}" \
            "${{ matrix.interval }}" \
            "${{ steps.dates.outputs.start }}" \
            "${{ steps.dates.outputs.end }}" \
            "$OUT"

      - name: 📂 Unzip & cleanup (falls ZIPs)
        run: |
          DIR=historical/${{ matrix.symbol }}/${{ matrix.interval }}/rolling
          for z in "$DIR"/*.zip; do
            unzip -q "$z" -d "$DIR"
            rm -f "$z"
          done

      - name: 🔄 Commit & Push CSVs
        run: |
          git stash push --include-untracked -m "pre-pull stash"
          git pull --rebase origin main
          git stash pop

          git add -A historical/${{ matrix.symbol }}/${{ matrix.interval }}/rolling

          if ! git diff --cached --quiet; then
            git commit -m "feat(history): add rolling ${{ matrix.symbol }} ${{ matrix.interval }} up to $(date -I) [skip ci]"
            git push origin HEAD:main
          else
            echo "→ No new CSVs for ${{ matrix.symbol }} / ${{ matrix.interval }}"
          fi
