name: ðŸ”„ Download 4yr Historical Data (Split)

on:
  workflow_dispatch:

jobs:
  download_history:
    name: Download per Symbol Ã— Part Ã— Interval
    runs-on: ubuntu-latest

    strategy:
      matrix:
        symbol:   [BTCUSDT,ETHUSDT,BNBUSDT,XRPUSDT,SOLUSDT,ENAUSDT]
        part:     [part1,part2]
        interval: [1m,5m,15m,1h,4h]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ”§ Make download script executable
        run: chmod +x train/download_data_range.sh

      - name: â±ï¸ Compute date range for ${{ matrix.part }}
        shell: bash
        run: |
          if [[ "${{ matrix.part }}" == "part1" ]]; then
            START=$(date -I -d "4 years ago")
            END=$(date -I -d "2 years ago")
          else
            START=$(date -I -d "2 years ago")
            END=$(date -I -d "yesterday")
          fi
          echo "START=$START" >> $GITHUB_ENV
          echo "END=$END"     >> $GITHUB_ENV

      - name: ðŸ“¥ Download ${{ matrix.symbol }} / ${{ matrix.interval }} / ${{ matrix.part }}
        run: |
          OUT=historical/${{ matrix.symbol }}/${{ matrix.part }}
          mkdir -p "$OUT"
          train/download_data_range.sh \
            "${{ matrix.symbol }}" \
            "${{ matrix.interval }}" \
            "$START" "$END" \
            "$OUT"

      - name: ðŸ“¦ Zip downloaded files
        run: |
          mkdir -p artifacts
          ZIP=artifacts/hist-${{ matrix.symbol }}-${{ matrix.interval }}-${{ matrix.part }}.zip
          zip -j "$ZIP" historical/${{ matrix.symbol }}/${{ matrix.part }}/*.zip

      - name: ðŸ“¤ Upload history artifact
        uses: actions/upload-artifact@v4
        with:
          # eindeutiger Name pro Job:
          name: history-${{ matrix.symbol }}-${{ matrix.interval }}-${{ matrix.part }}
          path: artifacts/hist-${{ matrix.symbol }}-${{ matrix.interval }}-${{ matrix.part }}.zip
