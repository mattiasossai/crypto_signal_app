name: ğŸ“¥ Download 8yr Historical Data (Split)

on:
  workflow_dispatch:

jobs:
  download-old:
    name: ğŸ“¦ ${{ matrix.symbol }}ï½œ${{ matrix.interval }}ï½œ2017â†’2021
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        symbol:   [BTCUSDT, ETHUSDT, BNBUSDT, XRPUSDT, SOLUSDT, ENAUSDT]
        interval: [1m, 5m, 15m, 1h, 4h]

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v3

      - name: âš™ï¸ Mach Download-Script ausfÃ¼hrbar
        run: chmod +x train/download_data_range.sh

      - name: ğŸ“… Setze Zeitspanne 2017â†’2021
        shell: bash
        run: |
          echo "START=2017-01-01" >> $GITHUB_ENV
          echo "END=2021-01-01"   >> $GITHUB_ENV

      - name: ğŸŒ Download ${{ matrix.symbol }} / ${{ matrix.interval }}
        run: |
          OUT=historical/${{ matrix.symbol }}/${{ matrix.interval }}/2017-2021
          mkdir -p "$OUT"
          train/download_data_range.sh \
            "${{ matrix.symbol }}" \
            "${{ matrix.interval }}" \
            "$START" "$END" \
            "$OUT"

      - name: ğŸ“¦ Zip & Skip empty
        shell: bash
        run: |
          mkdir -p artifacts
          ZIP="artifacts/hist-${{ matrix.symbol }}-${{ matrix.interval }}-2017-2021.zip"
          DIR="historical/${{ matrix.symbol }}/${{ matrix.interval }}/2017-2021"
          shopt -s nullglob
          files=( "$DIR"/*.zip )
          if [ ${#files[@]} -gt 0 ]; then
            zip -j "$ZIP" "${files[@]}"
            echo "â†’ Created $ZIP with ${#files[@]} files"
          else
            echo "â†’ No files for $DIR â€” skipping zip"
          fi

      - name: ğŸš€ Upload Artifact 2017â†’2021
        uses: actions/upload-artifact@v4
        with:
          name: historical-${{ matrix.symbol }}-${{ matrix.interval }}-2017-2021
          path: artifacts/hist-${{ matrix.symbol }}-${{ matrix.interval }}-2017-2021.zip

  download-new:
    name: ğŸ“¦ ${{ matrix.symbol }}ï½œ${{ matrix.interval }}ï½œ2021â†’heute
    needs: download-old
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        symbol:   [BTCUSDT, ETHUSDT, BNBUSDT, XRPUSDT, SOLUSDT, ENAUSDT]
        interval: [1m, 5m, 15m, 1h, 4h]

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v3

      - name: âš™ï¸ Mach Download-Script ausfÃ¼hrbar
        run: chmod +x train/download_data_range.sh

      - name: ğŸ“… Setze Zeitspanne 2021â†’heute
        shell: bash
        run: |
          echo "START=2021-01-01" >> $GITHUB_ENV
          echo "END=$(date -I -d "yesterday")" >> $GITHUB_ENV

      - name: ğŸŒ Download ${{ matrix.symbol }} / ${{ matrix.interval }}
        run: |
          OUT=historical/${{ matrix.symbol }}/${{ matrix.interval }}/2021-heute
          mkdir -p "$OUT"
          train/download_data_range.sh \
            "${{ matrix.symbol }}" \
            "${{ matrix.interval }}" \
            "$START" "$END" \
            "$OUT"

      - name: ğŸ“¦ Zip & Skip empty
        shell: bash
        run: |
          mkdir -p artifacts
          ZIP="artifacts/hist-${{ matrix.symbol }}-${{ matrix.interval }}-2021-heute.zip"
          DIR="historical/${{ matrix.symbol }}/${{ matrix.interval }}/2021-heute"
          shopt -s nullglob
          files=( "$DIR"/*.zip )
          if [ ${#files[@]} -gt 0 ]; then
            zip -j "$ZIP" "${files[@]}"
            echo "â†’ Created $ZIP with ${#files[@]} files"
          else
            echo "â†’ No files for $DIR â€” skipping zip"
          fi

      - name: ğŸš€ Upload Artifact 2021â†’heute
        uses: actions/upload-artifact@v4
        with:
          name: historical-${{ matrix.symbol }}-${{ matrix.interval }}-2021-heute
          path: artifacts/hist-${{ matrix.symbol }}-${{ matrix.interval }}-2021-heute.zip

