name: ðŸ“¥ Download Rolling History (last 30d)

on:
  workflow_dispatch:

jobs:
  download-history:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        symbol: [BTCUSDT, ETHUSDT, BNBUSDT, SOLUSDT, XRPUSDT, ENAUSDT]
        interval: [1m,5m,15m,1h,4h]
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install unzip
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: Download History for ${{ matrix.symbol }} @ ${{ matrix.interval }}
        run: |
          chmod +x historical/download_history_range.sh
          # wir laden die letzten 30 Tage bis gestern
          START=$(date -I -d "30 days ago")
          END=$(date -I -d "yesterday")
          historical/download_history_range.sh \
            "${{ matrix.symbol }}" \
            "${{ matrix.interval }}" \
            "$START" \
            "$END" \
            part2

      - name: Commit new CSVs
        run: |
          git config user.name "${GIT_USER}"
          git config user.email "${GIT_EMAIL}"
          # Nur die neu hinzugefÃ¼gten CSVs fÃ¼r dieses Symbol/Interval
          git add historical/${{ matrix.symbol }}/${{ matrix.interval }}/part2/*.csv

          if ! git diff --cached --quiet; then
            git commit -m "chore(history): add rolling ${{ matrix.symbol }} ${{ matrix.interval }} [skip ci]"
            git push origin HEAD:main
          else
            echo "ðŸš€ No new CSVs for ${{ matrix.symbol }} ${{ matrix.interval }}"
          fi
        env:
          GIT_USER: github-actions[bot]
          GIT_EMAIL: github-actions[bot]@users.noreply.github.com
