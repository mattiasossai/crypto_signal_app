# .github/workflows/download_history.yml
name: Download 4yr History (Split)

on:
  workflow_dispatch:

jobs:
  download:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        symbol: [BTCUSDT,ETHUSDT,BNBUSDT,XRPUSDT,SOLUSDT,ENAUSDT]
        part:   [part1,part2]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Make downloader executable
        run: chmod +x train/download_data_range.sh

      - name: Compute date range for ${{ matrix.part }}
        shell: bash
        run: |
          if [ "${{ matrix.part }}" = "part1" ]; then
            START=$(date -I -d "4 years ago")
            END=$(date -I -d "2 years ago")
          else
            START=$(date -I -d "2 years ago")
            END=$(date -I -d "yesterday")
          fi
          echo "START=$START" >> $GITHUB_ENV
          echo "END=$END"     >> $GITHUB_ENV

      - name: Download ${{ matrix.symbol }} ${{ matrix.part }}
        shell: bash
        run: |
          mkdir -p historical/${{ matrix.symbol }}/${{ matrix.part }}
          ./train/download_data_range.sh \
            "${{ matrix.symbol }}" 1m "$START" "$END" \
            "historical/${{ matrix.symbol }}/${{ matrix.part }}"

      - name: Zip historical/${{ matrix.symbol }}/${{ matrix.part }}
        shell: bash
        run: |
          mkdir -p artifacts
          DIR=historical/${{ matrix.symbol }}/${{ matrix.part }}
          # nur zippen, wenn dort wirklich .zip-Dateien liegen
          if compgen -G "$DIR/*.zip" > /dev/null; then
            zip -j artifacts/hist-${{ matrix.symbol }}-${{ matrix.part }}.zip "$DIR"/*.zip
          else
            echo "⚠️ No files in $DIR → skipping zip."
          fi

      - name: Upload all artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: history-zips
          path: artifacts/*.zip
